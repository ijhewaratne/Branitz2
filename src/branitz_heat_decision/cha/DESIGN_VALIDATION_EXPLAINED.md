# CHA Design Validation System - Complete Explanation

This document explains the CHA (Central Heating Analysis) design validation system, what each check means, and how to interpret the results.

**File Location**: `results/cha/{cluster_id}/design_validation.json`  
**Generated By**: `src/branitz_heat_decision/cha/design_validator.py`  
**Validation Standards**: EN 13941-1 (District Heating), Document 24 methodology

---

## Validation Overview

The design validation system performs **4 categories of checks**:

1. **Geospatial Validation**: Building connectivity, network topology, street alignment
2. **Hydraulic Validation**: Velocity, pressure, flow distribution (EN 13941-1)
3. **Thermal Validation**: Temperature distribution, heat losses
4. **Robustness Validation**: Monte Carlo uncertainty analysis (50 scenarios)

---

## Validation Report Structure

```json
{
  "cluster_id": "ST010_HEINRICH_ZILLE_STRASSE",
  "timestamp": "2026-01-24T05:40:03.947918",
  "validation_summary": {
    "passed": false,
    "level": "FAIL",
    "total_issues": 3,
    "total_warnings": 6
  },
  "check_results": {
    "geospatial": false,
    "hydraulic": true,
    "thermal": true,
    "robustness": false
  },
  "issues": [...],
  "warnings": [...],
  "metrics": {...}
}
```

**Status Levels**:
- **PASS**: All checks passed, no issues
- **PASS_WITH_WARNINGS**: All checks passed, but warnings present
- **FAIL**: One or more checks failed (issues present)

---

## Issue Categories Explained

### 1. Geospatial Issues

#### **"X buildings (Y MWh/a, Z% of demand) not connected to network"**

**What it means**: Some buildings in the cluster are not connected to the district heating network.

**How it's checked**:
- All buildings with `annual_heat_demand_kwh_a > 0` are identified
- For each heat exchanger/sink in the network, the nearest building is found
- Buildings within `max_connection_distance_m` (default: 50m) are considered "connected"
- Unconnected buildings are reported

**Example from your file**:
```
"2 buildings (283.6 MWh/a, 3.6% of demand) not connected to network"
```

**Impact**:
- **Low Impact** (if <5% of demand): Minor issue, may be acceptable
- **Medium Impact** (5-10%): Significant portion of demand not served
- **High Impact** (>10%): Major connectivity problem

**Possible Causes**:
- Buildings too far from network
- Network builder didn't create connections for all buildings
- Buildings outside the street network coverage

**How to Fix**:
- Check building locations relative to network
- Increase `max_connection_distance_m` threshold (if acceptable)
- Review network builder logic for building attachment

---

#### **"Network has X disconnected components (must be connected)"**

**What it means**: The network has multiple separate, unconnected parts. All parts must be connected to form a single network.

**How it's checked**:
- NetworkX graph analysis of pipe connectivity
- Counts number of connected components
- Should be exactly 1 (all pipes connected)

**Example from your file**:
```
"Network has 2 disconnected components (must be connected)"
```

**Impact**: **CRITICAL** - Network cannot function properly with disconnected components

**Possible Causes**:
- Network builder created separate subnetworks
- Missing connections between network parts
- Isolated junctions/pipes not connected to main network

**How to Fix**:
- Review network builder topology logic
- Check for missing connections between network segments
- Ensure all pipes are part of a single connected graph

---

#### **"X isolated junctions found (not connected to any pipe)"**

**What it means**: Some junctions exist in the network but are not connected to any pipes.

**How it's checked**:
- Compares all junctions to junctions used in pipes
- Isolated junctions = junctions not in any pipe's `from_junction` or `to_junction`

**Example from your file**:
```
"71 isolated junctions found (not connected to any pipe)"
```

**Impact**: **WARNING** - Not critical, but indicates network topology issues

**Possible Causes**:
- Junctions created but never used
- Network builder created extra junctions
- Cleanup step didn't remove unused junctions

**How to Fix**:
- Remove unused junctions from network
- Review network builder junction creation logic

---

### 2. Hydraulic Issues & Warnings

#### **"Maximum velocity X m/s exceeds recommended limit Y m/s (EN 13941-1)"**

**What it means**: Some pipes have flow velocity higher than the recommended limit.

**Standard**: EN 13941-1 recommends **≤ 1.5 m/s** for district heating pipes

**How it's checked**:
- Calculates `v_mean_m_per_s` for all pipes
- Flags pipes exceeding threshold

**Example from your file**:
```
"Maximum velocity 2.07 m/s exceeds recommended limit 1.5 m/s (EN 13941-1)"
```

**Impact**: **WARNING** - High velocity causes:
- Increased pressure losses
- Higher noise
- Potential pipe wear
- Risk of water hammer

**Possible Causes**:
- Pipes too small for flow rate
- High demand in specific areas
- Suboptimal pipe sizing

**How to Fix**:
- Increase pipe diameter for high-velocity pipes
- Redistribute flow
- Add parallel pipes

---

#### **"X pipes have velocity < 0.2 m/s (risk of sedimentation)"**

**What it means**: Some pipes have very low flow velocity, which can cause sediment buildup.

**Standard**: Minimum velocity **≥ 0.2 m/s** recommended to prevent sedimentation

**Example from your file**:
```
"28 pipes have velocity < 0.2 m/s (risk of sedimentation)"
```

**Impact**: **WARNING** - Low velocity causes:
- Sediment accumulation
- Reduced heat transfer
- Potential blockages
- Maintenance issues

**Possible Causes**:
- Pipes too large for flow rate
- Low demand in certain areas
- Over-sized pipes

**How to Fix**:
- Reduce pipe diameter for low-velocity pipes
- Increase flow (if possible)
- Consider pipe removal if flow is very low

---

#### **"Maximum pressure gradient X bar/km exceeds recommended Y bar/km"**

**What it means**: Pressure drop per kilometer is too high, indicating high energy losses.

**Standard**: Recommended **≤ 1.0 bar/km** for efficient operation

**Example from your file**:
```
"Maximum pressure gradient 2.50 bar/km exceeds recommended 1.0 bar/km"
```

**Impact**: **WARNING** - High pressure gradient causes:
- High pump power requirements
- Increased energy costs
- Potential pressure issues at consumers

**Possible Causes**:
- Pipes too small
- High flow rates
- Long pipe segments
- High friction losses

**How to Fix**:
- Increase pipe diameters
- Add pumps for pressure boost
- Optimize network layout

---

#### **"High flow distribution imbalance (CV=X), may indicate suboptimal network layout"**

**What it means**: Flow is unevenly distributed across the network.

**CV (Coefficient of Variation)**: Standard deviation / mean of flow rates

**Example from your file**:
```
"High flow distribution imbalance (CV=1.18), may indicate suboptimal network layout"
```

**Impact**: **WARNING** - Imbalanced flow indicates:
- Some pipes overloaded, others underutilized
- Suboptimal network topology
- Potential for better pipe sizing

**Possible Causes**:
- Uneven demand distribution
- Suboptimal network layout
- Inefficient routing

**How to Fix**:
- Review network topology
- Redistribute connections
- Optimize pipe routing

---

### 3. Robustness Issues

#### **"Network only converges successfully in X% of scenarios (threshold: Y%)"**

**What it means**: The network fails to converge or violates constraints in Monte Carlo uncertainty scenarios.

**Standard**: **≥ 95% success rate** required for robust design

**How it's checked**:
- Runs 50 Monte Carlo scenarios with:
  - Demand variations (±20%)
  - Temperature variations (±5°C)
- Each scenario must:
  1. Converge successfully
  2. Meet constraints (velocity ≤ 2.0 m/s, pressure 0.5-20 bar)

**Example from your file**:
```
"Network only converges successfully in 0.0% of scenarios (threshold: 95.0%)"
"50/50 scenarios violated constraints"
```

**Impact**: **CRITICAL** - Network is not robust to uncertainty

**Possible Causes**:
- Network design too sensitive to variations
- Constraint violations in base case
- Numerical convergence issues
- Insufficient margin in design

**How to Fix**:
- Increase pipe diameters (add margin)
- Improve network topology
- Add pressure/flow control
- Review constraint thresholds
- Check base case convergence first

---

## Understanding Your Specific Issues

Based on your `design_validation.json`:

### Critical Issues (Must Fix):

1. **Disconnected Components** (2 components)
   - Network has 2 separate parts
   - **Action**: Review network builder, ensure single connected network

2. **Robustness Failure** (0% success rate)
   - Network fails all 50 Monte Carlo scenarios
   - **Action**: Fix base case first, then add design margins

3. **Unconnected Buildings** (2 buildings, 3.6% demand)
   - Minor but should be addressed
   - **Action**: Check building locations, extend network if needed

### Warnings (Should Address):

1. **High Velocity** (2.07 m/s > 1.5 m/s)
   - 2 pipes exceed limit
   - **Action**: Increase pipe diameter for pipes 164, 165

2. **Low Velocity** (28 pipes < 0.2 m/s)
   - Sedimentation risk
   - **Action**: Reduce pipe diameters or increase flow

3. **High Pressure Gradient** (2.50 bar/km > 1.0 bar/km)
   - High energy losses
   - **Action**: Increase pipe diameters or add pumps

4. **Flow Imbalance** (CV=1.18)
   - Uneven distribution
   - **Action**: Review network topology

5. **Isolated Junctions** (71 junctions)
   - Cleanup needed
   - **Action**: Remove unused junctions

---

## Validation Configuration

Validation thresholds are defined in:
- `src/branitz_heat_decision/config/validation_standards.py`

**Key Thresholds**:
- `max_velocity_m_per_s`: 1.5 m/s (EN 13941-1)
- `min_velocity_m_per_s`: 0.2 m/s (sedimentation prevention)
- `max_pressure_drop_per_km`: 1.0 bar/km
- `max_connection_distance_m`: 50 m (building connection)
- `min_success_rate`: 0.95 (95% for robustness)
- `n_scenarios`: 50 (Monte Carlo robustness)

---

## How Validation is Run

### In CHA Pipeline (`01_run_cha.py`)

```python
from branitz_heat_decision.cha.design_validator import DHNetworkDesignValidator

validator = DHNetworkDesignValidator()
report = validator.validate_design(
    net=net,
    cluster_id=cluster_id,
    streets_gdf=streets,
    buildings_gdf=buildings,
    run_robustness=True
)

# Save report
validator.save_report(report, output_dir)
```

### Validation Checks Performed

1. **Geospatial** (`geospatial_checks.py`):
   - Street alignment
   - Building connectivity
   - Topology sanity (isolated junctions, disconnected components)

2. **Hydraulic** (`hydraulic_checks.py`):
   - Velocity limits (EN 13941-1)
   - Pressure drops
   - Pump power
   - Flow distribution

3. **Thermal** (`thermal_checks.py`):
   - Temperature distribution
   - Heat losses
   - Return temperature

4. **Robustness** (`robustness_checks.py`):
   - Monte Carlo scenarios (50)
   - Demand variations (±20%)
   - Temperature variations (±5°C)
   - Constraint violations

---

## Interpreting Results

### Status Levels

**PASS**: ✅ All checks passed
- Network meets all requirements
- Safe to proceed

**PASS_WITH_WARNINGS**: ⚠️ Checks passed, but warnings present
- Network functional but suboptimal
- Should address warnings for better performance

**FAIL**: ❌ One or more checks failed
- Network has critical issues
- Must fix before deployment

### Priority of Fixes

1. **Critical (Must Fix)**:
   - Disconnected components
   - Robustness failure (<95% success)
   - Convergence failures

2. **High Priority**:
   - Unconnected buildings (>5% demand)
   - Velocity violations (many pipes)
   - Pressure issues

3. **Medium Priority**:
   - Low velocity pipes (sedimentation risk)
   - Flow imbalance
   - Isolated junctions

4. **Low Priority**:
   - Minor warnings
   - Optimization opportunities

---

## Common Issues & Solutions

### Issue: Disconnected Components

**Cause**: Network builder created separate subnetworks

**Solution**:
1. Check network builder topology logic
2. Ensure all building attachment points are reachable from plant
3. Review street graph connectivity
4. Use trunk-spur builder (`--use-trunk-spur`) for better connectivity

### Issue: Robustness Failure (0% success)

**Cause**: Network too sensitive or base case has issues

**Solution**:
1. **First**: Fix base case convergence
2. **Then**: Add design margins (larger pipes)
3. **Check**: Constraint thresholds (may be too strict)
4. **Review**: Network topology for bottlenecks

### Issue: High Velocity

**Cause**: Pipes too small for flow rate

**Solution**:
1. Identify high-velocity pipes (from metrics)
2. Increase pipe diameter
3. Or add parallel pipes
4. Re-run validation

### Issue: Low Velocity

**Cause**: Pipes too large for flow rate

**Solution**:
1. Identify low-velocity pipes
2. Reduce pipe diameter (save costs)
3. Or increase flow (if possible)
4. Remove pipes if flow is very low

### Issue: Unconnected Buildings

**Cause**: Buildings too far from network or network builder missed them

**Solution**:
1. Check building locations
2. Extend network to reach buildings
3. Or increase `max_connection_distance_m` (if acceptable)
4. Review building attachment logic

---

## Validation Metrics Explained

### Geospatial Metrics

- `building_connectivity_pct`: % of buildings connected (target: 100%)
- `connected_buildings_count`: Number of connected buildings
- `unconnected_buildings_count`: Number of unconnected buildings
- `network_components`: Number of connected components (target: 1)
- `isolated_junctions`: Number of unused junctions
- `street_alignment_pct`: % of pipes following streets (target: 100%)

### Hydraulic Metrics

- `max_velocity_m_per_s`: Maximum flow velocity (target: ≤ 1.5 m/s)
- `min_velocity_m_per_s`: Minimum flow velocity (target: ≥ 0.2 m/s)
- `pipes_exceeding_velocity`: Count of pipes exceeding limit
- `pipes_below_min_velocity`: Count of pipes below minimum
- `max_pressure_drop_per_km`: Maximum pressure gradient (target: ≤ 1.0 bar/km)
- `flow_coefficient_of_variation`: Flow distribution balance (lower is better)

### Thermal Metrics

- `heat_loss_pct`: Percentage of heat lost (target: <5%)
- `total_heat_delivered_mw`: Total heat delivered to consumers
- `supply_temp_c`: Supply temperature
- `return_temp_c`: Return temperature
- `temp_spread_c`: Temperature difference (target: 30-40°C)

### Robustness Metrics

- `robustness_success_rate`: % of successful scenarios (target: ≥95%)
- `scenarios_tested`: Number of Monte Carlo scenarios (default: 50)
- `scenarios_successful`: Number of successful scenarios
- `scenarios_failed`: Number of failed scenarios

---

## Next Steps for Your Network

Based on your validation results:

### Immediate Actions:

1. **Fix Disconnected Components**:
   ```bash
   # Re-run CHA with trunk-spur builder (better connectivity)
   python src/scripts/01_run_cha.py --cluster-id ST010_HEINRICH_ZILLE_STRASSE \
     --use-trunk-spur --optimize-convergence
   ```

2. **Fix Robustness**:
   - First ensure base case converges
   - Then add design margins (larger pipes)
   - Re-run validation

3. **Address High Velocity Pipes**:
   - Check pipes 164, 165 (from metrics)
   - Increase diameter
   - Re-run validation

### Validation Files Generated

- `design_validation.json`: Complete validation report (JSON)
- `design_validation_summary.txt`: Human-readable summary
- `design_validation_metrics.csv`: Detailed metrics (CSV)

---

## References

- **EN 13941-1**: District heating pipes - Design and installation
- **Document 24**: Internal validation methodology
- **Validation Code**: `src/branitz_heat_decision/cha/design_validator.py`
- **Check Modules**: `geospatial_checks.py`, `hydraulic_checks.py`, `thermal_checks.py`, `robustness_checks.py`

---

**Last Updated**: 2026-01-19  
**Module Version**: v1.0  
**Primary Maintainer**: CHA Development Team
